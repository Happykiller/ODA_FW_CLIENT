<div class="container">
    <h2 oda-label="oda-resetPwd.title">oda-resetPwd.title</h2>
    <p>
        <span oda-label="oda-resetPwd.intro">oda-resetPwd.intro</span><span id="userCode" style="font-weight: bolder"></span>
    </p>
    <div class="row">
        <div class="col-md-12">
            <div class="form-group">
                <label for="email" oda-label="oda-main.contact-mail">email</label>
                <input type="text" class="form-control" oda-input-text="email" oda-input-text-tips="oda-main.contact-mail-tips" oda-input-text-placeholder="oda-main.contact-mail-placeholder" oda-input-text-check="Oda.Regexs:mail">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="pwd" oda-label="oda-main.password">Password :</label>
                <input required type="password" class="form-control" oda-input-text="pwd" oda-input-text-tips="oda-main.io-pass-tips" oda-input-text-placeholder="oda-main.io-pass" oda-input-text-check="Oda.Regexs:pass">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="pwd" oda-label="oda-resetPwd.Confirmpassword">Confirm password :</label>
                <input required type="password" class="form-control" oda-input-text="pwd2" oda-input-text-tips="oda-main.io-pass-tips" oda-input-text-placeholder="oda-main.io-pass" oda-input-text-check="Oda.Regexs:pass">
            </div>
        </div>
        <div class="col-md-12">
            <p>
                <button type="button" oda-label="oda-main.bt-submit" oda-submit="submit" onclick="$.Oda.Controller.ResetPwd.reset();" class="btn btn-primary disabled" disabled>Submit</button >
                <button type="button" oda-label="oda-main.bt-back" onclick="$.Oda.Router.navigateTo({'route':'home','args':[]});" class="btn btn-info">Back</button >
            </p>
        </div>
    </div>
</div>

<script>
    $.Oda.Controller.ResetPwd = {
        "userCode":null,
        /**
         * @returns {$.Oda.Controller.ResetPwd}
         */
        start: function () {
            try {
                var tokenUri;
                try{
                    tokenUri = decodeURI($.Oda.Context.window.location);
                }catch (er) {
                    tokenUri = unescape($.Oda.Context.window.location);
                }
                var compressToken = $.Oda.Tooling.getParameterGet({url: tokenUri});
                var data = LZString.decompress(compressToken.token);
                var token = JSON.parse(data);
                if(!token.hasOwnProperty("userCode") || !token.hasOwnProperty("valideDate")){
                    $.Oda.Log.error("Token for reset password not valid");
                    $.Oda.Router.routes["404"].go();
                }else if((token.userCode !== undefined) && (token.userCode !== "") && (token.valideDate !== undefined) && (token.valideDate < new Date())){
                    $('#userCode').html(token.userCode);
                    $.Oda.Controller.ResetPwd.userCode = token.userCode;
                    $.Oda.Scope.Gardian.add({
                        id : "resetPwd",
                        listElt : ["email","pwd", "pwd2"],
                        function : function(params){
                            if( ($("#email").data("isOk")) && ($("#pwd").data("isOk")) && ($("#pwd2").data("isOk")) && ($("#pwd").val() === $("#pwd2").val()) ){
                                $("#submit").btDisable();
                            }else{
                                $("#submit").btEnable();
                            }
                        }
                    });
                }else{
                    $.Oda.Log.error("Token params for reset password not valid");
                    $.Oda.Router.routes["404"].go();
                }
                return this;
            } catch (er) {
                $.Oda.Log.error("$.Oda.Controller.ResetPwd.start : " + er.message);
                return null;
            }
        },
        /**
         * @returns {$.Oda.Controller.ResetPwd}
         */
        reset: function () {
            try {
                var tabInput = {
                    "userCode": $.Oda.Controller.ResetPwd.userCode,
                    "pwd" : $("#pwd").val(),
                    "email": $("#email").val()
                };
                var call = $.Oda.Interface.callRest($.Oda.Context.rest+"vendor/happykiller/oda/resources/api/rest/user/pwd/", {"type": "put", callback : function(response){
                    $.Oda.Router.navigateTo({'route':'home','args':[]});
                }},tabInput);
                return this;
            } catch (er) {
                $.Oda.Log.error("$.Oda.Controller.ResetPwd.start : " + er.message);
                return null;
            }
        }
    };
    
    $.Oda.Controller.ResetPwd.start();
</script>