<div class="container">
    <h2 oda-label="oda-main.subscrib-title">Forgot</h2>
    <p  oda-label="oda-main.subscrib-intro">Intro</p>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="firstName" oda-label="oda-main.subscrib-firstName">oda-main.subscrib-firstName</label>
                <input required="" type="text" class="form-control" oda-input-text="firstName" oda-input-text-tips="oda-main.subscrib-firstName-tips" oda-input-text-placeholder="oda-main.subscrib-firstName-placeholder" oda-input-text-check="Oda.Regexs:firstName">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="lastName" oda-label="oda-main.subscrib-lastName">oda-main.subscrib-lastName</label>
                <input type="text" class="form-control" oda-input-text="lastName" oda-input-text-tips="oda-main.subscrib-lastName-tips" oda-input-text-placeholder="oda-main.subscrib-lastName-placeholder" oda-input-text-check="Oda.Regexs:lastName">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="email" oda-label="oda-main.contact-mail">oda-main.contact-mail</label>
                <input type="text" value="" class="form-control" oda-input-text="email" oda-input-text-tips="oda-main.contact-mail-tips" oda-input-text-check="Oda.Regexs:mail">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="mdp" oda-label="oda-main.password">oda-main.password</label>
                <input type="password" value="" class="form-control" oda-input-text="mdp" oda-input-text-tips="oda-main.io-pass-tips" oda-input-text-check="Oda.Regexs:pass">
            </div>
        </div>
        <div class="col-md-12">
            <p>
                <span oda-label="oda-main.login">login</span>&nbsp;<span id="login" style="font-weight: bold;"></span>
            </p>
        </div>
        <div class="col-md-12">
            <p>
                <oda-btn oda-btn-name="submit" oda-btn-style="primary" oda-btn-enter="1" oda-btn-click="$.Oda.Controller.Subscrib.createAccount();" disabled>oda-main.bt-submit</oda-btn>
                <oda-btn oda-btn-style="info" oda-btn-click="$.Oda.Router.navigateTo({'route':'home','args':[]});">oda-main.bt-back</oda-btn>
            </p>
        </div>
    </div>
</div>

<script>
    $.Oda.Controller.Subscrib = {
        /**
         * @returns {$.Oda.Controller.Subscrib}
         */
        start: function() {
            try {
                $.Oda.Scope.Gardian.add({
                    id : "gardianSubscrib",
                    listElt : ["firstName", "lastName", "email", "mdp"],
                    function : function(params){
                        if(($("#firstName").data("isOk")) && ($("#lastName").data("isOk")) && ($("#email").data("isOk")) && ($("#mdp").data("isOk"))){
                            var first = $("#firstName").val().replace(/[^\w\s]/gi, '');
                            var last = $("#lastName").val().replace(/[^\w\s]/gi, '');

                            var login = (first.substring(0,2) + last.substring(0,2)).toUpperCase();
                            $("#login").text(login);
                            $("#submit").btEnable();
                        }else{
                            $("#login").text("");
                            $("#submit").btDisable();
                        }
                    }
                });
                return this;
            } catch (er) {
                $.Oda.Log.error("$.Oda.Controller.Subscrib.start: " + er.message);
                return null;
            }
        },
        /**
         * @returns {$.Oda.Controller.Subscrib}
         */
        createAccount: function() {
            try {
                $("#submit").btDisable();
                var firstName = $("#firstName").val();
                var lastName = $("#lastName").val();
                var email = $("#email").val();
                var mdp = $("#mdp").val();
                var login = $("#login").text();

                var tabInput = { nom: lastName, prenom: firstName, email: email, motDePasse: mdp, codeUtilisateur: login };
                var results = $.Oda.Interface.callRest($.Oda.Context.rest+"vendor/happykiller/oda/resources/api/addUtilisateur.php", {callback: function(results){
                    var infoUser = results.data.infosUser;

                    var message_html  = $.Oda.Display.TemplateHtml.create({
                        template : "mailSubscribe",
                        scope : {
                            "code_user": infoUser.code_user,
                            "firstName": firstName,
                            "lastName": lastName,
                            "siteUrl": $.Oda.Context.host
                        }
                    });

                    var sujet = "[ODA-" + $.Oda.Interface.getParameter("nom_site") + "]Cr√©ation de compte.";

                    var contact_mail_administrateur = $.Oda.Interface.getParameter("contact_mail_administrateur");

                    var paramsMail = {
                        email_mails_dest: infoUser.mail
                        ,email_mail_ori: contact_mail_administrateur
                        , email_labelle_ori: "Service Mail ODA"
                        , email_mail_reply: contact_mail_administrateur
                        , email_labelle_reply: "Service Mail ODA"
                        , email_mails_cache: contact_mail_administrateur
                        , message_html: message_html
                        , sujet: sujet
                    };

                    $.Oda.Interface.sendMail(paramsMail);

                    var strHtml = "F&eacute;licitation votre compte a bien &eacute;t&eacute; cr&eacute;&eacute; (N&deg;"+infoUser.id+", identifiant : "+infoUser.code_user+").";
                    $.Oda.Display.Notification.success(strHtml);

                    $("#firstName").val("");
                    $("#lastName").val("");
                    $("#email").val("");
                    $("#mdp").val("");
                    $("#login").text("");
                    
                    $("#submit").btEnable();
                }}, tabInput);
                return this;
            } catch (er) {
                $.Oda.Log.error("$.Oda.Controller.Subscrib.createAccount: " + er.message);
                return null;
            }
        },
    };

    $.Oda.Controller.Subscrib.start();
</script>

<script id="mailSubscribe" type="text/template">
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional //EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
    <html xmlns:v="urn:schemas-microsoft-com:vml">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;">
        <link href='https://fonts.googleapis.com/css?family=Questrial' rel='stylesheet' type='text/css'>
    </head>
    <body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">

    <table bgcolor="#343846" width="100%" border="0" cellpadding="10px" cellspacing="0">
        <tbody>
        <tr>
            <td>
                <font face="verdana" color="#d3d3d3">
                    Bonjour {{firstName}} {{lastName}},<br>
                    <br>
                    Votre compte a bien &eacute;t&eacute; cr&eacute;&eacute;.<br>
                    <br>
                    Pour rappel : <br>
                    - votre identifiant : {{code_user}}<br>
                    <br>
                    Merci et rendez-vous <a href='{{siteUrl}}'><font color="#add8e6">ici</font></a><br>
                    <br>
                    L'&eacute;quipe<br>
                </font>
            </td>
        </tr>
        </tbody>
    </table>

    </html>
</script>